rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function inUserRoles(userId) {
      return exists(/databases/$(database)/documents/userRoles/$(userId));
    }
    
    // Helper function to check if user has any role (is admin)
    function isAdmin(userId) {
      return request.auth != null && inUserRoles(userId)
    }

    // Helper function to check if user is the document owner
    function isOwner(id, resourceId) {
      return request.auth != null && id == resourceId;
    }

    // =====================
    // USERS COLLECTION
    // =====================
    match /users/{userId} {
      allow read: if isAdmin(request.auth.uid) || isOwner(request.auth.uid, userId);
      allow write: if isAdmin(request.auth.uid);
      allow update: if isOwner(request.auth.uid, userId);
    }

    // =====================
    // ROLES COLLECTION
    // =====================
    match /roles/{roleId} {
      allow read: if isAdmin(request.auth.uid);
      allow write: if isAdmin(request.auth.uid);
    }

    // =====================
    // USER_ROLES COLLECTION
    // =====================

    // Structure: userRoles/{userId} -> { roleIds: [...], assigned: {...} }
    match /userRoles/{userId} {
      allow read: if isOwner(request.auth.uid, userId);
      allow read, write: if isAdmin(request.auth.uid);
    }

    // =====================
    // MANDATE CERTIFICATES COLLECTION
    // =====================

    // Structure: mandateCertificates/{mandateId} -> { userId, mandateId, ... }
    match /mandateCertificates/{certificateId} {
      allow read: if isOwner(certificateId, resource.data.userId);
      allow read, write: if isAdmin(request.auth.uid);
    }

    // =====================
    // ARTICLES COLLECTION
    // =====================
    match /articles/{articleId} {
      allow read: if request.auth != null;
      allow write: if isAdmin(request.auth.uid);
    }

    // =====================
    // EVENTS COLLECTION
    // =====================
    match /events/{eventId} {
      allow read: if request.auth != null;
      allow write: if isAdmin(request.auth.uid);
    }

    // =====================
    // CHAPTERS COLLECTION
    // =====================
    match /chapters/{chapterId} {
      allow read: if request.auth != null;
      allow write: if isAdmin(request.auth.uid);
    }

    // =====================
    // MEDIA COLLECTION
    // =====================
    match /media/{mediaId} {
      allow read: if request.auth != null;
      allow write: if isAdmin(request.auth.uid);
    }

    // =====================
    // MANDATES COLLECTION
    // =====================
    match /mandates/{mandateId} {
      allow read: if request.auth != null;
      allow write: if isAdmin(request.auth.uid);
    }

    // =====================
    // EVENT_REGISTRATIONS COLLECTION
    // =====================
    match /eventRegistrations/{registrationId} {
      allow read: if request.auth != null;
      allow write: if isAdmin(request.auth.uid);
    }

    // =====================
    // NEWSLETTER COLLECTION
    // =====================
    match /newsletters/{newsletterId} {
      allow read: if request.auth != null;
      allow write: if isAdmin(request.auth.uid);
    }

    // =====================
    // NEWSLETTER_SUBSCRIPTIONS COLLECTION
    // =====================
    match /newsletterSubscriptions/{subscriptionId} {
      allow read: if isOwner(request.auth.uid, resource.data.userId);
      allow write: if isOwner(request.auth.uid, request.resource.data.userId);
      allow read, update: if isAdmin(request.auth.uid);
    }

    // =====================
    // UPLOADS COLLECTION
    // =====================
    match /uploads/{uploadId} {
      allow read: if request.auth != null;
      allow write: if isAdmin(request.auth.uid);
    }

    // =====================
    // MANDATE_CERTIFICATE_SETTINGS COLLECTION
    // =====================
    match /mandateCertificates/settings {
      allow read: if request.auth != null;
      allow write: if isAdmin(request.auth.uid);
      allow delete: if false;
    }

    // =====================
    // DEFAULT DENY
    // =====================
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
