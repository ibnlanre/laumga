rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  	function isAuthenticated() {
    	return request.auth != null;
    }
  
    function inUserRoles(userId) {
      return exists(/databases/$(database)/documents/userRoles/$(userId));
    }
    
    // Helper function to check if user has any role (is admin)
    function isAdmin(userId) {
      return isAuthenticated() && inUserRoles(userId);
    }

    // Helper function to check if user is the document owner
    function isOwner(id, resourceId) {
      return isAuthenticated() && id == resourceId;
    }

    // =====================
    // USERS COLLECTION
    // =====================
    match /users/{userId} {
    	allow read: if true;
      allow create, update: if isOwner(request.auth.uid, userId);
      allow write: if isAdmin(request.auth.uid);
    }
    
    // Alias for backward compatibility
    match /user/{userId} {
      allow read: if true;
      allow create, update: if isOwner(request.auth.uid, userId);
      allow write: if isAdmin(request.auth.uid);
    }

    // =====================
    // ROLES COLLECTION
    // =====================
    match /roles/{roleId} {
      allow read: if isAdmin(request.auth.uid);
      allow write: if isAdmin(request.auth.uid);
    }

    // =====================
    // USER_ROLES COLLECTION
    // =====================

    // Structure: userRoles/{userId} -> { roleIds: [...], assigned: {...} }
    match /userRoles/{userId} {
      allow read: if isOwner(request.auth.uid, userId);
      allow read, write: if isAdmin(request.auth.uid);
    }

    // =====================
    // MANDATE CERTIFICATES COLLECTION
    // =====================
    // Structure: mandateCertificates/{mandateId} -> { userId, mandateId, ... }
    match /mandateCertificates/{certificateId} {
      allow read: if isOwner(request.auth.uid, resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read, write: if isAdmin(request.auth.uid);
    }

    // =====================
    // ARTICLES COLLECTION
    // =====================
    match /articles/{articleId} {
      // Articles are public; reads must be open for slug existence checks and public listings
      allow read: if true;
      allow write: if isAdmin(request.auth.uid);
    }

    // =====================
    // EVENTS COLLECTION
    // =====================
    match /events/{eventId} {
      // Event cards show up on public routes and we probe for duplicates client-side
      allow read: if true;
      allow write: if isAdmin(request.auth.uid);
    }

    // =====================
    // CHAPTERS COLLECTION
    // =====================
    match /chapters/{chapterId} {
      // Registration forms resolve chapters before auth, so reads must be public
      allow read: if true;
      allow write: if isAdmin(request.auth.uid);
    }

    // =====================
    // MEDIA COLLECTION
    // =====================
    match /media/{mediaId} {
      allow read: if true;
      allow write: if isAdmin(request.auth.uid);
    }

    // =====================
    // MANDATES COLLECTION
    // =====================
    match /mandates/{mandateId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(request.resource.data.userId, request.auth.uid);
      allow update, delete: if isAdmin(request.auth.uid);
    }

    // =====================
    // EVENT_REGISTRATIONS COLLECTION
    // =====================
    match /eventRegistrations/{registrationId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin(request.auth.uid);
    }

    // =====================
    // NEWSLETTER COLLECTION
    // =====================
    match /newsletters/{newsletterId} {
      allow read: if true;
      allow write: if isAdmin(request.auth.uid);
    }

    // =====================
    // NEWSLETTER_SUBSCRIPTIONS COLLECTION
    // =====================
    match /newsletterSubscriptions/{subscriptionId} {
      allow create, read: if true;
      allow read, write: if isAdmin(request.auth.uid);   
    }
    
    // =====================
    // NOTIFICATIONS COLLECTION
    // =====================
    match /notifications/{notificationId} {
      allow create: if true;
      allow read, write: if isAdmin(request.auth.uid);
    }

    // =====================
    // UPLOADS COLLECTION
    // =====================
    match /uploads/{uploadId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin(request.auth.uid);
    }

    // =====================
    // MANDATE_CERTIFICATE_SETTINGS COLLECTION
    // =====================
    match /mandateCertificates/settings {
      allow read: if isAuthenticated();
      allow write: if isAdmin(request.auth.uid);
      allow delete: if false;
    }

    // =====================
    // DEFAULT DENY
    // =====================
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
